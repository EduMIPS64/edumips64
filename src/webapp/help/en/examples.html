

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Code Examples &#8212; EduMIPS64 1.3.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/epub.css?v=e4d0adb4" />
    <script src="_static/documentation_options.js?v=1f29e9d3"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="code-examples">
<h1>Code Examples<a class="headerlink" href="#code-examples" title="Link to this heading">¶</a></h1>
<p>In this chapter you’ll find some sample listings that will be useful in
order to understand how EduMIPS64 works.</p>
<section id="syscall">
<h2>SYSCALL<a class="headerlink" href="#syscall" title="Link to this heading">¶</a></h2>
<p>It’s important to understand that examples for SYSCALL 1-4 refer to the
<cite>print.s</cite> file, that is the example for SYSCALL 5. If you want to run the
examples, you should copy the content of that example in a file named
<cite>print.s</cite> and include it in your code.</p>
<p>Some examples use an already existing file descriptor, even if it doesn’t truly
exist. If you want to run those examples, use the SYSCALL 1 example to open a
file.</p>
<section id="syscall-0">
<h3>SYSCALL 0<a class="headerlink" href="#syscall-0" title="Link to this heading">¶</a></h3>
<p>When SYSCALL 0 is called, it stops the execution of the program.
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">code</span>
    <span class="n">daddi</span>   <span class="n">r1</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="mi">0</span>    <span class="p">;</span> <span class="n">saves</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">R1</span>
    <span class="n">syscall</span> <span class="mi">0</span>            <span class="p">;</span> <span class="n">exits</span>
</pre></div>
</div>
</section>
<section id="syscall-1">
<h3>SYSCALL 1<a class="headerlink" href="#syscall-1" title="Link to this heading">¶</a></h3>
<p>Example program that opens a file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                .data
error_op:       .asciiz     &quot;Error opening the file&quot;
ok_message:     .asciiz     &quot;All right&quot;
params_sys1:    .asciiz     &quot;filename.txt&quot;
                .word64     0xF

                .text
open:           daddi       r14, r0, params_sys1
                syscall     1
                daddi       $s0, r0, -1
                dadd        $s2, r0, r1
                daddi       $a0,r0,ok_message
                bne         r1,$s0,end
                daddi       $a0,r0,error_op

end:            jal         print_string
                syscall 0

                #include    print.s
</pre></div>
</div>
<p>In the first two rows we write to memory the strings containing the error
message and the success message that we will pass to print_string function, and
we give them two labels. The print_string function is included in the print.s
file.</p>
<p>Next, we write to memory the data required from SYSCALL 1 (row 4, 5), the
path of the file to be opened (that must exist if we work in read or
read/write mode) and, in the next memory cell, an integer that defines the
opening mode.</p>
<p>In this example, the file was opened using the following modes:
<cite>O_RDWR</cite> | <cite>O_CREAT</cite> | <cite>O_APPEND</cite>. The
number 15 (0xF in base 16) comes from the sum of the values of these three
modes (3 + 4 + 8).</p>
<p>We give a label to this data so that we can use it later.</p>
<p>In the .text section, we save the address of params_sys1 (that for the
compiler is a number) in register r14; next we can call SYSCALL 1 and save
the content of r1 in $s2, so that we can use it in the rest of the program
(for instance, with other SYSCALL).</p>
<p>Then the print_string function is called, passing error_op as an argument if
r1 is equal to -1 (rows 13-14) or else passing ok_message as an argument if
everything went smoothly (rows 12 and 16).</p>
</section>
<section id="syscall-2">
<h3>SYSCALL 2<a class="headerlink" href="#syscall-2" title="Link to this heading">¶</a></h3>
<p>Example program that closes a file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                .data
params_sys2:    .space 8
error_cl:       .asciiz     &quot;Error closing the file&quot;
ok_message:     .asciiz     &quot;All right&quot;

                .text
close:          daddi       r14, r0, params_sys2
                sw          $s2, params_sys2(r0)
                syscall     2
                daddi       $s0, r0, -1
                daddi       $a0, r0, ok_message
                bne         r1, $s0, end
                daddi       $a0, r0, error_cl

end:            jal         print_string
                syscall     0

                #include    print.s
</pre></div>
</div>
<p>First we save some memory for the only argument of SYSCALL 2, the file
descriptor of the file that must be closed (row 2), and we give it a label so
that we can access it later.</p>
<p>Next we put in memory the strings containing the error message and the success
message, that will be passed to the print_string function (rows 3, 4).</p>
<p>In the .text section, we save the address of params_sys2 in r14; then we can
call SYSCALL 2.</p>
<p>Now we call the print_string function using error_cl as a parameter if r1
yields -1 (row 13), or we call it using ok_message as a parameter if all went
smoothly (row 11).</p>
<p><strong>Note:</strong> This listing needs that registry $s2 contains the
file descriptor of the file to use.</p>
</section>
<section id="syscall-3">
<h3>SYSCALL 3<a class="headerlink" href="#syscall-3" title="Link to this heading">¶</a></h3>
<p>Example program that reads 16 bytes from a file and saves them to memory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                .data
params_sys3:    .space      8
ind_value:      .space      8
                .word64     16
error_3:        .asciiz     &quot;Error while reading from file&quot;
ok_message:     .asciiz     &quot;All right&quot;

value:          .space      30

                .text
read:           daddi       r14, r0, params_sys3
                sw          $s2, params_sys3(r0)
                daddi       $s1, r0, value
                sw          $s1, ind_value(r0)
                syscall     3
                daddi       $s0, r0, -1
                daddi       $a0, r0,ok_message
                bne         r1, $s0,end
                daddi       $a0, r0,error_3

end:            jal         print_string
                syscall     0

                #include    print.s
</pre></div>
</div>
<p>The first 4 rows of the .data section contain the arguments of SYSCALL 3, the
file descriptor of the from which we must read, the memory address where the
SYSCALL must save the read data, the number of bytes to read. We give labels
to those parameters that must be accessed later. Next we put, as usual, the
strings containing the error message and the success message.</p>
<p>In the .text section, we save the params_sys3 address to register r14, we save
in the memory cells for the SYSCALL parameters the file descriptor (that we
suppose to have in $s2) and the address that we want to use to save the read
bytes.</p>
<p>Next we can call SYSCALL 3, and then we call the print_string function
passing as argument error_3 or ok_message, according to the success of the
operation.</p>
</section>
<section id="syscall-4">
<h3>SYSCALL 4<a class="headerlink" href="#syscall-4" title="Link to this heading">¶</a></h3>
<p>Example program that writes to a file a string:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                .data
params_sys4:    .space      8
ind_value:      .space      8
                .word64     16
error_4:        .asciiz     &quot;Error writing to file&quot;
ok_message:     .asciiz     &quot;All right&quot;
value:          .space      30

                .text

write:          daddi       r14, r0,params_sys4
                sw          $s2, params_sys4(r0)
                daddi       $s1, r0,value
                sw          $s1, ind_value(r0)
                syscall     4
                daddi       $s0, r0,-1
                daddi       $a0, r0,ok_message
                bne         r1, $s0,end
                daddi       $a0, r0,error_4

end:            jal         print_string
                syscall     0

                #include    print.s
</pre></div>
</div>
<p>The first 4 rows of the .data section contain the arguments of SYSCALL 4, the
file descriptor of the from which we must read, the memory address from where
the SYSCALL must read the bytes to write, the number of bytes to write. We
give labels to those parameters that must be accessed later. Next we put, as
usual, the strings containing the error message and the success message.</p>
<p>In the .text section, we save the params_sys4 address to register r14, we save
in the memory cells for the SYSCALL parameters the file descriptor (that we
suppose to have in $s2) and the address from where we must take the bytes to
write.</p>
<p>Next we can call SYSCALL 3, and then we call the print_string function
passing as argument error_3 or ok_message, according to the success of the
operation.</p>
</section>
<section id="syscall-5">
<h3>SYSCALL 5<a class="headerlink" href="#syscall-5" title="Link to this heading">¶</a></h3>
<p>Example program that contains a function that prints to standard output the
string contained in $a0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                .data
params_sys5:    .space  8

                .text
print_string:
                sw      $a0, params_sys5(r0)
                daddi   r14, r0, params_sys5
                syscall 5
                jr      r31
</pre></div>
</div>
<p>The second row is used to save space for the string that must be printed by the
SYSCALL, that is filled by the first instruction of the .text section, that
assumes that in $a0 there’s the address of the string to be printed.</p>
<p>The next instruction puts in r14 the address of this string, and then we can
call SYSCALL 5 and print the string. The last instruction sets the program
counter to the content of r31, as the usual MIPS calling convention states.</p>
</section>
<section id="a-more-complex-usage-example-of-syscall-5">
<h3>A more complex usage example of SYSCALL 5<a class="headerlink" href="#a-more-complex-usage-example-of-syscall-5" title="Link to this heading">¶</a></h3>
<p>SYSCALL 5 uses a not-so-simple arguments passing mechanism, that will be
shown in the following example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                <span class="o">.</span><span class="n">data</span>
<span class="n">format_str</span><span class="p">:</span>     <span class="o">.</span><span class="n">asciiz</span>   <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">th of </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> version </span><span class="si">%i</span><span class="s2">.</span><span class="si">%i</span><span class="s2"> is being tested!&quot;</span>
<span class="n">s1</span><span class="p">:</span>             <span class="o">.</span><span class="n">asciiz</span>   <span class="s2">&quot;June&quot;</span>
<span class="n">s2</span><span class="p">:</span>             <span class="o">.</span><span class="n">asciiz</span>   <span class="s2">&quot;EduMIPS64&quot;</span>
<span class="n">fs_addr</span><span class="p">:</span>        <span class="o">.</span><span class="n">space</span>    <span class="mi">4</span>
                <span class="o">.</span><span class="n">word</span>     <span class="mi">5</span>
<span class="n">s1_addr</span><span class="p">:</span>        <span class="o">.</span><span class="n">space</span>    <span class="mi">4</span>
<span class="n">s2_addr</span><span class="p">:</span>        <span class="o">.</span><span class="n">space</span>    <span class="mi">4</span>
                <span class="o">.</span><span class="n">word</span>     <span class="mi">0</span>
                <span class="o">.</span><span class="n">word</span>     <span class="mi">5</span>
<span class="n">test</span><span class="p">:</span>
                <span class="o">.</span><span class="n">code</span>
                <span class="n">daddi</span>     <span class="n">r5</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">format_str</span>
                <span class="n">sw</span>        <span class="n">r5</span><span class="p">,</span> <span class="n">fs_addr</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>
                <span class="n">daddi</span>     <span class="n">r2</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">s1</span>
                <span class="n">daddi</span>     <span class="n">r3</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">s2</span>
                <span class="n">sd</span>        <span class="n">r2</span><span class="p">,</span> <span class="n">s1_addr</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>
                <span class="n">sd</span>        <span class="n">r3</span><span class="p">,</span> <span class="n">s2_addr</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>
                <span class="n">daddi</span>     <span class="n">r14</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">fs_addr</span>
                <span class="n">syscall</span>   <span class="mi">5</span>
                <span class="n">syscall</span>   <span class="mi">0</span>
</pre></div>
</div>
<p>The address of the format string is put into R5, whose content is then saved to
memory at address fs_addr. The string parameters’ addresses are saved into
s1_addr and s2_addr. Those two string parameters are the ones that match the
two %s placeholders in the format string.</p>
<p>Looking at the memory, it’s obvious that the parameters matching the
placeholders are stored immediately after the address of the format string:
numbers match integer parameters, while addresses match string parameters. In
the s1_addr and s2_addr locations there are the addresses of the two strings
that we want to print instead of the %s placeholders.</p>
<p>The execution of the example will show how SYSCALL 5 can handle complex format
strings like the one stored at format_str.</p>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>