# Gradle
# Build your Java project and run tests with Gradle using a Gradle wrapper script.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
- master

schedules:
- cron: "0 0 * * *"
  displayName: Daily midnight build
  always: true
  branches:
    include:
    - master

pool:
  vmImage: 'Ubuntu-18.04'

# JDK 1.9 and 1.10 are out of support on Azure Pipeline tasks
strategy:
  matrix:
    JDK-8:
        jdk-ver: '1.8'
        artifact-name: 'edumips64-jdk8'
    JDK-11:
        jdk-ver: '1.11'
        artifact-name: 'edumips64-jdk11'


steps:
- script: |
      sudo pip3 install -r docs/requirements.txt
  displayName: 'Install docs dependencies'

- task: Gradle@2
  displayName: 'Compile source code'
  inputs:
    gradleWrapperFile: 'gradlew'
    gradleOptions: '-Xmx3072m'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: $(jdk-ver)
    jdkArchitectureOption: 'x64'
    tasks: 'compileJava'

- task: Gradle@2
  displayName: 'Run unit tests'
  inputs:
    gradleWrapperFile: 'gradlew'
    gradleOptions: '-Xmx3072m'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: $(jdk-ver)
    jdkArchitectureOption: 'x64'
    tasks: 'check'
    publishJUnitResults: true
    testResultsFiles: '**/TEST-*.xml'

- task: Gradle@2
  displayName: 'Build all docs'
  inputs:
    gradleWrapperFile: 'gradlew'
    gradleOptions: '-Xmx3072m'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: $(jdk-ver)
    jdkArchitectureOption: 'x64'
    tasks: 'allDocs'

- task: Gradle@2
  displayName: 'Build Web UI'
  inputs:
    gradleWrapperFile: 'gradlew'
    gradleOptions: '-Xmx3072m'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: $(jdk-ver)
    jdkArchitectureOption: 'x64'
    tasks: 'war'

- script: bash <(curl -s https://codecov.io/bash)
  displayName: 'Codecov update'
  env:
    CODECOV_TOKEN: $(codecov_token)

- task: Gradle@2
  displayName: 'Create all JARs'
  inputs:
    gradleWrapperFile: 'gradlew'
    gradleOptions: '-Xmx3072m'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: $(jdk-ver)
    jdkArchitectureOption: 'x64'
    tasks: 'assemble'

- task: PublishBuildArtifacts@1
  displayName: 'Publish standalone artifact'
  inputs:
    pathtoPublish: './build/libs'
    artifactName: '$(artifact-name)-standalone'

- task: PublishBuildArtifacts@1
  displayName: 'Publish English manual'
  inputs:
    pathtoPublish: './build/docs/en/latex/EduMIPS64.pdf'
    artifactName: 'edumips64-docs-en'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Italian manual'
  inputs:
    pathtoPublish: './build/docs/it/latex/EduMIPS64.pdf'
    artifactName: 'edumips64-docs-it'
